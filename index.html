<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" type="text/css" href="./css/style.css">
	<script type="text/javascript" src="http://platform.linkedin.com/in.js">
		api_key: 77lw834nbnef0f
		authorize: true
	</script>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCWZWDTQeqpZqmNQA9m1ThJHcR6pqQbvgk&sensor=false">
    </script>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js">
	</script>
    <script type="text/javascript">

    // $(function() {
    // 	initialize();
    // });

    var geocoder, map,
    	mapOptions = {
		  center: new google.maps.LatLng(41.96727,-71.18495),
		  zoom: 3
		}

    function getLocations(userData) {
    	console.log("USER DATA: " + userData[0]);
		geocoder.geocode( {"address": userData[0][0]["location"]["name"]}, function(results, status) {
			console.log(results);
		    if (status == google.maps.GeocoderStatus.OK) {
		      map.setCenter(results[0].geometry.location);
		      var marker = new google.maps.Marker({
		          map: map,
		          position: results[0].geometry.location
		      });
		    } else {
		      alert('Geocode was not successful for the following reason: ' + status);
		    }
		});
	};

	function onLinkedInAuth() {
		IN.API.Profile("me").fields("id", "first-name", "location", "positions").result( function(me) {
			var id=me.values[0].id;
			console.log(me.values[0].lastName);
			var fName=me.values[0].firstName
			var lName=me.values[0].lastName
			$.ajax({
				type: 'POST',
				url: '/request',
				data: JSON.stringify(me.values[0]),
				contentType: "application/json; charset=utf-8",
				//dataType: "string",
				complete: function(){},
				processData: false,
				success: function(){
					console.log("success");
					initialize();
				},
				error: function(jqXHR, textStatus, errorThrown){
					console.log("bad: " + textStatus + ": " + errorThrown);
				}
			});
			// initialize();
		});
	};

    function initialize() {
    	console.log('initializing google maps');
    	// console.log("no initialized map");
      	geocoder = new google.maps.Geocoder();
      	map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
  	    // var locationsArray = new Array();
  	    console.log("initialized map");
  	    // var userData;

	    $.ajax({
	    	type: 'GET',
	    	url: '/map-pins',
	    	complete: function(){},
			success: function(data){
				// console.log(data[0]);
				getLocations(data);
			},
			error: function(jqXHR, textStatus, errorThrown){
				console.log("bad: " + textStatus + ": " + errorThrown);
			}
	    });
	};

    google.maps.event.addDomListener(window, 'load', initialize);
    
    </script>
  </head>
  <body>
	<script type="IN/Login" data-onAuth="onLinkedInAuth"></script>
    <div id="map-outer"><div id="map-canvas"/></div></div>
	<div><p>CS ALUMNI</p></div>
	<div id="el"><p>stuff</p></div>
  </body>
</html>
